<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
        <title>Accelerometer Demo</title>
        <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

        <script>
          const clientId = 'mqttjs_' + Math.random().toString(16).substr(2, 8)
          const host = 'wss://lbefba77.ala.us-east-1.emqxsl.com:8084/mqtt'
          // const host = 'mqtt://lbefba77.ala.us-east-1.emqxsl.com:8883/mqtt'
          const options = {
            keepalive: 60,
            protocolId: 'MQTT',
            protocolVersion: 4,
            clean: true,
            reconnectPeriod: 1000,
            connectTimeout: 30 * 1000,
            // clientId: 'emqx_test',
            clientId: clientId,
            username: 'mqtt',
            password: 'mqtt',
            will: {
              topic: 'WillMsg',
              payload: 'Connection Closed abnormally..!',
              qos: 0,
              retain: false
            },
          }
          const client  = mqtt.connect(host, options)
          client.on('connect', function () {
            console.log('Connected')
            // Subscribe to a topic
            client.subscribe('test', function (err) {
              if (!err) {
                // Publish a message to a topic
                client.publish('test', 'Hello mqtt')
              }
            })

            client.subscribe('accelZ')
          })

          client.on('error', function (error) {
            console.log(error)
          })

          // Receive messages
          client.on('message', function (topic, message) {
            // message is Buffer
            console.log(message.toString())
            // client.end()
          })
      </script>

        <script>
          var px = 50; // Position x and y
          var py = 50;
          var vx = 0.0; // Velocity x and y
          var vy = 0.0;
          var vz = 0.0;
          var updateRate = 1/1; // Sensor refresh rate
          var cntAccel = 0
          var cntGyro = 0
          // var inc = 0
          let gyroX
          let gyroY
          let gyroZ

          function getAccel(){
            
              DeviceMotionEvent.requestPermission().then(response => {
                  if (response == 'granted') {
                    document.getElementById('accelPermsButton').style.display = "none"
                      window.addEventListener('devicemotion', (event) => {
                        accelZ = parseFloat(event.acceleration.z).toFixed(2)
                        // inc += event.acceleration.z
                        console.log(accelZ);
                        // Send a test message with QoS of 0 to the testtopic
                        if (cntAccel == 10) {
                          // client.publish('inc', inc.toString());
                          client.publish('accelZ', accelZ.toString(), { qos: 0, retain: false }, function (error) {
                            if (error) {
                              console.log(error)
                            } else {
                              console.log('Published')
                            }
                          })
                          cntAccel = 0
                          document.getElementById('accelData').innerHTML = accelZ.toString()
                        } else {
                          cntAccel++;
                        }
                      })


                      window.addEventListener('deviceorientation',(event) => {

                          gyroX = parseFloat(event.beta).toFixed(2)
                          gyroY = parseFloat(event.gamma).toFixed(2)
                          gyroZ = parseFloat(event.alpha).toFixed(2)

                          let gyro = {
                            x: gyroX,
                            y: gyroY,
                            z: gyroZ
                          }


                          if (cntGyro == 10) {
                            client.publish('gyro', JSON.stringify(gyro), { qos: 0, retain: false });
                            client.publish('gyroX', gyroX.toString(), { qos: 0, retain: false });
                            client.publish('gyroY', gyroY.toString(), { qos: 0, retain: false });
                            client.publish('gyroZ', gyroZ.toString(), { qos: 0, retain: false });

                            cntGyro = 0;

                            document.getElementById('gyroData').innerHTML = gyroX.toString() + " : " + gyroY.toString() + " : " + gyroZ.toString()

                          } else {
                            cntGyro++;
                          }

                          // Expose each orientation angle in a more readable way
                          // rotation_degrees = event.alpha;
                          // frontToBack_degrees = event.beta;
                          // leftToRight_degrees = event.gamma;
                          
                          // // Update velocity according to how tilted the phone is
                          // // Since phones are narrower than they are long, double the increase to the x velocity
                          // vx = vx + leftToRight_degrees * updateRate*2; 
                          // vy = vy + frontToBack_degrees * updateRate;
                          
                          // // Update position and clip it to bounds
                          // px = px + vx*.5;
                          // if (px > 98 || px < 0){ 
                          //     px = Math.max(0, Math.min(98, px)) // Clip px between 0-98
                          //     vx = 0;
                          // }

                          // py = py + vy*.5;
                          // if (py > 98 || py < 0){
                          //     py = Math.max(0, Math.min(98, py)) // Clip py between 0-98
                          //     vy = 0;
                          // }
                          
                          // dot = document.getElementsByClassName("indicatorDot")[0]
                          // dot.setAttribute('style', "left:" + (px) + "%;" +
                          //                               "top:" + (py) + "%;");
                          
                      });
                  }
              });
          }
        </script>

        <style>
        .indicatorDot{
            width: 30px;
            height: 30px;
            background-color: #ffab56;
            border-radius: 50%;
            position:fixed;
        }
        .txtValue {
          font-family: 'Courier New', Courier, monospace;
          font-size: 100px;
          color: white;
          width: 100%;
          text-align: center;
        }
        </style>

    <script></script>
    </head>
    <body style="background-color:black;">
        <button id="accelPermsButton"  style="height:50px;" onclick="getAccel()"><h1>Get Accelerometer Permissions</h1></button>
        <!-- <div class="indicatorDot" style="left:30%; top:30%;"></div> -->
        <div class="txtValue" id="accelData"></div>
        <div class="txtValue" id="gyroData"></div>
    </body>
</html>

